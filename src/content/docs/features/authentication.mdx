---
title: 认证系统
---

AI SaaS Template 现已全面接入 **Better Auth**，替换了早期的 Clerk 方案。新的认证层与 Drizzle ORM、tRPC 以及前端守卫组件深度整合，为企业级 SaaS 提供稳定、类型安全且可扩展的认证体验。

## 系统概览

### 核心特性

- **一体化认证**：Better Auth 负责邮箱密码、OAuth、会话管理等基础能力
- **深度集成**：服务端、tRPC 与客户端 Hook 共用一套状态模型
- **角色与权限**：内置多级管理员模型（普通用户 / Admin / Super Admin）
- **扩展字段**：用户表默认支持偏好设置、国际化、封禁、设备信息等
- **状态同步优化**：`authStateManager` 缓存会话、减少 API 请求抖动
- **可观测性**：所有关键流程都带有日志，方便排查认证链路

### 技术架构

```mermaid
graph TD
  U[用户] --> A[Next.js App Router]
  A -->|API 调用| B[/api/auth/[...all]]
  B --> C[Better Auth Server]
  C --> D[(PostgreSQL + Drizzle)]
  C --> E[Better Auth Hooks / Client]
  A --> F[tRPC Router]
  F --> C
  F --> D
  A --> G[Auth Hooks & Guards]
  G --> E
```

## 环境变量

在 `.env` / `.env.local` 中配置 Better Auth 相关变量：

```bash
# Better Auth 核心配置
BETTER_AUTH_SECRET="your-secret-key-change-in-production"
BETTER_AUTH_URL="http://localhost:3000"            # 可选，部署后使用生产域名

# 社交登录（可选）
GOOGLE_CLIENT_ID="..."
GOOGLE_CLIENT_SECRET="..."
NEXT_PUBLIC_GOOGLE_CLIENT_ID="..."

# 前端登录/注册路径（保持默认即可）
NEXT_PUBLIC_SIGN_IN_URL="/auth/login"
NEXT_PUBLIC_SIGN_UP_URL="/auth/register"
```

> `BETTER_AUTH_SECRET` 需要至少 32 位随机字符串。生产环境务必替换默认值。

## 目录结构

```text
src/
├─ lib/auth/better-auth/
│  ├─ server.ts        # betterAuth 服务端实例（Drizzle 适配器、邮箱/OAuth 配置）
│  ├─ client.ts        # 浏览器端 authClient + useBetterAuth Hook
│  ├─ state-manager.ts # 会话缓存与状态同步控制
│  ├─ permissions.ts   # 服务器端权限工具（cache + db 查询）
│  └─ roles.ts         # 枚举与工具函数
├─ hooks/auth/
│  ├─ use-auth.ts      # 统一客户端认证 Hook（登录、登出、状态同步、跳转）
│  └─ use-permissions.ts # 客户端权限判断
├─ components/auth/    # BetterAuthGuard、AuthGuardClient 等 UI 守卫
└─ app/api/auth/[...all]/route.ts # Better Auth API 入口
```

## 服务端集成

### Better Auth 实例

```ts title="src/lib/auth/better-auth/server.ts"
import { betterAuth } from 'better-auth'
import { drizzleAdapter } from 'better-auth/adapters/drizzle'
import { admin, username } from 'better-auth/plugins'
import { accounts, sessions, users, verificationTokens } from '@/drizzle/schemas'
import { env } from '@/env'
import { db } from '@/lib/db'

export const auth = betterAuth({
  database: drizzleAdapter(db, {
    provider: 'pg',
    schema: { user: users, session: sessions, account: accounts, verification: verificationTokens },
    usePlural: false,
  }),
  secret: env.BETTER_AUTH_SECRET,
  baseURL: env.BETTER_AUTH_URL || env.NEXT_PUBLIC_SITE_URL,
  emailAndPassword: { enabled: true, requireEmailVerification: false },
  socialProviders: env.GOOGLE_CLIENT_ID ? { /* ...google 配置... */ } : {},
  plugins: [username(), admin()],
  user: {
    additionalFields: {
      fullName: { type: 'string', defaultValue: null },
      isAdmin: { type: 'boolean', defaultValue: false },
      adminLevel: { type: 'number', defaultValue: 0 },
      isActive: { type: 'boolean', defaultValue: true },
      locale: { type: 'string', defaultValue: 'zh' },
      preferences: { type: 'string', defaultValue: JSON.stringify({ theme: 'light', language: 'zh' }) },
    },
  },
  session: {
    expiresIn: 60 * 60 * 24 * 7,
    updateAge: 60 * 60 * 2,
    cookieCache: { enabled: true, maxAge: 60 * 60 * 2 },
  },
})
```

### API 路由

```ts title="src/app/api/auth/[...all]/route.ts"
import { toNextJsHandler } from 'better-auth/next-js'
import { auth } from '@/lib/auth/better-auth/server'

export const { POST, GET } = toNextJsHandler(auth)
export const runtime = 'nodejs'
export const dynamic = 'force-dynamic'
```

该路由接管 Better Auth 所有 API（登录、注册、会话、OAuth 回调等）。

### tRPC Context 与中间件

`tRPC` 通过 `auth.api.getSession` 读取会话并补充数据库扩展字段：

```ts title="src/server/server.ts"
export async function createTRPCContext({ req }: { req: NextRequest }) {
  const session = await auth.api.getSession({ headers: req.headers as any })
  const dbUser = session?.user
    ? await db.query.users.findFirst({ where: eq(users.id, session.user.id) })
    : null

  return {
    db,
    userId: session?.user?.id ?? null,
    user: dbUser ? { ...session.user, ...dbUser } : session?.user ?? null,
    headers: req.headers,
    logger: console,
  }
}
```

配合 `src/server/better-auth-middleware.ts` 中的 `protectedProcedure / adminProcedure / superAdminProcedure`，即可在路由级别完成权限校验。

### 权限工具

```ts title="src/lib/auth/better-auth/permissions.ts"
export const getCurrentUser = cache(async () => {
  const session = await auth.api.getSession({ headers: new Headers() })
  if (!session?.user) return null
  const user = await db.query.users.findFirst({ where: eq(users.id, session.user.id) })
  return user ? { ...session.user, ...user } : session.user
})

export async function isAdmin() {
  const user = await getCurrentUser()
  return (user?.adminLevel ?? AdminLevel.USER) >= AdminLevel.ADMIN
}
```

## 数据库模型

Better Auth 使用 Drizzle 定义的以下核心表（节选）：

```ts title="src/drizzle/schemas/users.ts"
export const users = pgTable('user', {
  id: text('id').primaryKey(),
  email: text('email').notNull().unique(),
  emailVerified: boolean('email_verified').default(false),
  name: text('name'),
  image: text('image'),
  fullName: text('full_name'),
  isAdmin: boolean('is_admin').default(false),
  adminLevel: integer('admin_level').default(0),
  isActive: boolean('is_active').default(true),
  banned: boolean('banned').default(false),
  locale: varchar('locale', { length: 10 }).default('zh'),
  preferences: jsonb('preferences').default({ theme: 'light', language: 'zh', currency: 'CNY', timezone: 'Asia/Shanghai' }),
  createdAt: timestamp('created_at').defaultNow(),
  updatedAt: timestamp('updated_at').defaultNow(),
})
```

还包括 `sessions`、`accounts`、`verificationTokens`、`loginLogs` 等表，用于会话追踪与审计。

> 运行 `pnpm drizzle:push` 或相应的迁移命令，确保数据库结构与最新 schema 同步。

## 客户端集成

### Better Auth Client

```ts title="src/lib/auth/better-auth/client.ts"
export const authClient = createAuthClient({
  baseURL: typeof window !== 'undefined' ? window.location.origin : process.env.NEXT_PUBLIC_SITE_URL,
  plugins: [usernameClient(), adminClient()],
})

export const { signIn, signUp, signOut, useSession, getSession } = authClient

export function useBetterAuth() {
  const { data: session, isPending } = useSession()
  return {
    user: session?.user as ExtendedUser | null,
    isLoading: isPending,
    isAuthenticated: !!session?.user,
    login: signIn,
    logout: signOut,
    register: signUp,
  }
}
```

### 状态管理器

`authStateManager` 缓存服务端会话，减少重复请求并提供强制同步能力：

```ts title="src/lib/auth/better-auth/state-manager.ts"
class AuthStateManager {
  async getSession(force = false) {
    if (!force && cache有效) return cachedData
    this.sessionCache.promise = authClient.getSession()
    const result = await this.sessionCache.promise
    this.sessionCache = { data: result, timestamp: Date.now(), promise: null }
    return result
  }

  async waitForAuthSync(maxAttempts = 5) { /* 强制刷新，确保登录后状态一致 */ }
}
```

### Hooks 与守卫

- `useAuth`：对 `useBetterAuth` 进行二次封装，提供登录流程、错误处理、智能重定向
- `useBetterAuthPermissions`：返回 `isAdmin / isSuperAdmin` 等角色状态
- `BetterAuthGuard` / `AuthGuardClient`：页面级守卫，自动处理加载态、重定向、未授权提示

示例：

```tsx
import { BetterAuthGuard } from '@/components/auth/BetterAuthGuard'

export default function AdminPage() {
  return (
    <BetterAuthGuard requiredRole="admin">
      <AdminContent />
    </BetterAuthGuard>
  )
}
```

## 常见流程

1. **邮箱/密码登录**：`useAuth().signIn` 调用 Better Auth API → `authStateManager` 强制同步 → 重定向到 `/{locale}/dashboard`
2. **社交登录**：前端跳转到 `/api/auth/social/google`，Better Auth 完成 OAuth 回调并写入 `accounts` 表
3. **tRPC 调用**：`protectedProcedure` 自动注入用户上下文；如需额外权限使用 `adminProcedure`、`superAdminProcedure`
4. **权限控制**：客户端通过 `useBetterAuthPermissions` 决定是否渲染按钮/入口；服务端同样使用 `isAdmin()` 等函数确保安全
5. **登出**：`useAuth().signOut` 清理会话，`authStateManager.clearCache()` 及时使缓存失效

## 调试与排查

- 打开浏览器控制台可看到 `AuthStateManager` 的日志（缓存命中、防抖阻止等）
- 在开发环境下，`window.authStateManager` 暴露了调试方法，可手动调用 `clearCache()`、`getStats()`
- Better Auth 所有错误都会写入 `console`，配合 `authRouter`、`tRPC` 中的日志可快速定位问题

## 下一步

- 如需新增自定义字段，可在 `server.ts -> user.additionalFields` 中扩展，并同步更新 Drizzle schema
- 对接企业邮箱服务时实现 `emailAndPassword.sendResetPassword`
- 如果启用多租户或子域支持，开启 `crossSubDomainCookies` 并配置生产域名

通过以上模块化的设计，Better Auth 与 AI SaaS Template 的各个子系统紧密协作，既保持了灵活性，也大幅降低了集成与维护成本。
