---
title: AI 多模态架构概览
---

本章节汇总 AI 聊天模块的技术基线，帮助贡献者理解 `ai-sdk@5` 在项目中的封装方式，以及后续阶段如何在此基础上扩展多模态能力。

## 目录结构

```text
src/lib/ai-sdk/
├── client.ts          # 前端/SDK 使用的 HTTP + SSE 封装
├── errors.ts          # SDK 异常分类器，统一转换为域内错误
├── index.ts           # Barrel file，导出所有工具
├── model-registry.ts  # 模型解析注册表，支持字符串 ID → Provider 实例
├── server.ts          # 服务端 generate/stream 包装，内置入参校验
├── stream.ts          # 通用 SSE 解析工具，支持 JSON/文本
├── types.ts           # 调用参数、回调、HTTP 请求选项类型
└── __tests__/         # Vitest 单元测试
```

## 服务端封装

- `generateAiText`：基于 `generateText` 的同步推理封装。
  - 支持 Prompt 或多轮 Messages 二选一，自动裁剪空字符串。
  - 通过 `resolveAiModel` 将字符串模型 ID 映射为底层 `LanguageModel` 实例。
  - 保留 `CallSettings` 入参（温度、最大 Token 等）并透传 `providerOptions`、`experimental_telemetry`。
- 默认模型：导出 `DEFAULT_AI_MODEL_ID`（当前为 `openai/gpt-4o`），当调用方未指定 `model` 时，`generateAiText`/`streamAiText` 会自动回退到该模型。
- `streamAiText`：封装 `streamText` 的流式推理，用于后续聊天/语音场景。
  - 支持 `includeRawChunks`，便于实验性能力透传。
  - 返回原始 `StreamTextResult`，由上层决定如何消费。
- `model-registry.ts`：提供注册/清理解析器的能力，方便在阶段 4+ 引入不同模型、字符到实例的映射，以及在测试中注入假实现。

## 前端与流式消费

- `createAiClient`：统一前端调用 AI API 的入口。
  - `request`：普通 JSON 请求，自动拼接 `baseUrl`、写入默认 Header，并在遇到 204 响应时返回 `undefined`。
  - `stream`：针对 SSE 的 POST 请求，接受自定义解析方法与回调，内部复用了 `parseSseStream`。
- `parseSseStream`：面向浏览器/Node 的基础 SSE 解析，支持 `[DONE]` 终止标记、`AbortSignal` 中断、JSON 或纯文本回调。
  - 后续阶段可复用该函数，统一处理文本、语音、工具调用等多类型 chunk。

## 错误治理

- `describeAiError`：根据 `ai` SDK 的异常类型分类成域内类别（输入错误、响应异常、鉴权、速率限制、网络、未知）。
- `isAiSdkError`：辅助判断异常是否源自 SDK，以便统一展示和告警。
- 该模块将结合阶段 9 的可观测性，进一步扩展日志元数据。

## 测试基线

Vitest 单测覆盖以下场景（`pnpm test`）：

- 服务端封装：参数校验、模型解析、`includeRawChunks` 透传。
- 客户端封装：URL 规范化、错误处理、SSE 流委托。
- SSE 工具：`[DONE]` 终止、AbortSignal、解析异常回调。
- 错误分类器：不同异常类型的分类与 `isAiSdkError` 判定。

:::note
本仓库已有 `tests/pages/home.test.tsx` 空测试文件，会导致 Vitest 报错 “No test suite found”。运行测试时可使用 `pnpm test --run src/lib/ai-sdk` 或补充该文件的测试用例来恢复全局通过。
:::

## 下一步

Phase 1 将基于此基线扩展 Drizzle 结构与会话 API，Phase 2/3 继续集成前端界面与流式消息处理。完成后请同步更新：

1. `docs/aichat/plan.md` 里的阶段进度。
2. `src/content/docs/zh/aichat` 下对应专题文档（数据模型、会话流程等）。
3. `docs/aichat/changelog.md`（阶段完成纪要）。
