---
title: 会话流程
---

本节介绍阶段 2 交付的核心聊天 API：如何通过 tRPC 维护会话上下文、写入消息、触发流式推理，并在失败时回退。

## tRPC 路由结构

- 路径：`appRouter.aichat`
- 权限：全部过程均使用 `protectedProcedure`，仅认证用户可访问。
- 关键过程：
  - `listSessions`：分页读取当前用户的会话，按照 `updatedAt` 倒序返回。
  - `getSessionMessages`：读取指定会话的消息列表，默认最多 40 条并返回顺序化结果。
  - `createSession`：创建新会话，默认模型为 `openai/gpt-4o`，支持覆写标题、System Prompt、模式。
  - `clearSession`：删除会话内的消息、附件，并重置摘要与时间戳。
  - `sendMessage`：流式推理主流程，返回 `observable<AiChatStreamEvent>`，包含 `session`、`user-message`、`assistant-delta`、`assistant-end`、`error` 等事件。

## 请求 → 响应流程

1. **会话校验**：
   - 若传入 `sessionId`，调用 `assertSessionOwnership` 确认归属，失败则抛出 `NOT_FOUND`。
   - 未传入会话 ID 时自动创建，会话标题尝试从用户消息截断生成。
2. **写入用户消息**：立即插入角色为 `user` 的消息记录，并更新会话 `lastMessageAt`。
3. **占位助手消息**：插入 `streaming` 状态的助手消息，事件流发送 `assistant-start`。
4. **AI 调用**：
   - 使用 `streamAiText`，传入历史消息 `ModelMessage[]`、系统提示、`providerOptions` 与可选 `CallSettings`。
   - 将 `textStream` 的每个增量通过 `assistant-delta` 事件推送给前端。
5. **完成或失败**：
   - 成功后更新助手消息状态与文本，并发送 `assistant-end`（附带 `usage`、`totalUsage`）。
   - 失败时写入错误原因，发送 `error` 事件。
6. **终止**：可通过 `AbortController` 取消流；Observable 在 `unsubscribe` 时自动中断。

## 事件载荷示例

```ts
export type AiChatStreamEvent =
  | { type: 'session'; sessionId: string }
  | { type: 'user-message'; messageId: string }
  | { type: 'assistant-start'; messageId: string }
  | { type: 'assistant-delta'; messageId: string; delta: string }
  | {
      type: 'assistant-end'
      messageId: string
      text: string
      usage?: LanguageModelUsage
      totalUsage?: LanguageModelUsage
    }
  | {
      type: 'error'
      message: string
      retryable: boolean
      category: string
    }
```

## 与 AI SDK 文档的对应

- 参考 `generateText` / `streamText` 最佳实践，默认模型同阶段 0 (`DEFAULT_AI_MODEL_ID`).
- 参照官方建议处理 `result.textStream`、`result.usage`、`result.totalUsage`，并在错误时使用 `describeAiError` 分类。
- Observable 包装与官方示例一致，前端可使用 `subscribe` 或转换为 `ReadableStream`。

## 错误与回退

- 输入校验失败（如 `sessionId` 不是 UUID）将抛出 `BAD_REQUEST`。
- 未找到会话或权限不足返回 `NOT_FOUND`。
- AI SDK 异常统一映射为 `AiErrorDescriptor`，前端可根据 `category` 与 `retryable` 决定提示。

## 测试覆盖

新增 Vitest 单元测试（`src/server/routers/__tests__/aichat.test.ts`）：

- 验证默认模型创建与 `streamAiText` 调用参数。
- 模拟 AI 流式增量事件，断言返回 Observable 事件顺序、助手消息与调用参数。
- 通过内存数据库替身校验会话、消息入库逻辑。

## 下一步

阶段 3 将围绕应用页面与前端组件消费上述事件流，构建 UI 与状态管理。
