# ğŸ” Coolify Dockerfile éƒ¨ç½²é…ç½®å®¡æŸ¥æŠ¥å‘Š

**å®¡æŸ¥æ—¥æœŸ**: 2025-11-13
**çŠ¶æ€**: âœ… **å·²é€šè¿‡ - ç¬¦åˆç”Ÿäº§éƒ¨ç½²æ ‡å‡†**

---

## âœ… é…ç½®æ£€æŸ¥ç»“æœ

### 1. Next.js é…ç½® âœ…

**æ–‡ä»¶**: `next.config.ts`

| é…ç½®é¡¹ | çŠ¶æ€ | è¯´æ˜ |
|--------|------|------|
| `output: 'standalone'` | âœ… å·²é…ç½® | Docker éƒ¨ç½²å¿…éœ€ï¼Œå‡å°é•œåƒä½“ç§¯ |
| `compress: true` | âœ… å·²é…ç½® | å¯ç”¨ gzip å‹ç¼© |
| `poweredByHeader: false` | âœ… å·²é…ç½® | éšè— X-Powered-By å¤´ï¼Œæå‡å®‰å…¨æ€§ |
| å›¾ç‰‡ä¼˜åŒ– | âœ… å·²é…ç½® | AVIF/WebP æ ¼å¼ï¼Œ30å¤©ç¼“å­˜ |
| å®‰å…¨å¤´éƒ¨ | âœ… å·²é…ç½® | X-Frame-Options, CSP ç­‰ |
| Webpack ä¼˜åŒ– | âœ… å·²é…ç½® | ä»£ç åˆ†å‰²ï¼ŒTree Shaking |

**éªŒè¯å‘½ä»¤**:
```bash
grep "output:" next.config.ts
# è¾“å‡º: output: 'standalone',
```

---

### 2. Dockerfile é…ç½® âœ…

**æ–‡ä»¶**: `Dockerfile`

#### å¤šé˜¶æ®µæ„å»º
```dockerfile
FROM node:20-alpine AS base      # åŸºç¡€é•œåƒ
FROM base AS deps                # ä¾èµ–å®‰è£…é˜¶æ®µ
FROM base AS builder             # æ„å»ºé˜¶æ®µ
FROM base AS runner              # è¿è¡Œé˜¶æ®µ
```

| é˜¶æ®µ | ä¼˜åŒ–ç‚¹ | çŠ¶æ€ |
|------|--------|------|
| **base** | ä½¿ç”¨è½»é‡ Alpine é•œåƒ | âœ… |
| **deps** | ä½¿ç”¨ corepack ç®¡ç† pnpm | âœ… |
| **deps** | å®‰è£…æ‰€æœ‰ä¾èµ–ï¼ˆæ„å»ºéœ€è¦ï¼‰ | âœ… |
| **builder** | å¤åˆ¶ node_modules è€Œéé‡æ–°å®‰è£… | âœ… |
| **builder** | è®¾ç½® NODE_ENV=production | âœ… |
| **builder** | ä½¿ç”¨ `pnpm run build` | âœ… |
| **runner** | åˆ›å»ºé root ç”¨æˆ· (nextjs) | âœ… |
| **runner** | åªå¤åˆ¶å¿…è¦çš„è¿è¡Œæ—¶æ–‡ä»¶ | âœ… |
| **runner** | å¤åˆ¶ standalone è¾“å‡º | âœ… |
| **runner** | å¤åˆ¶é™æ€æ–‡ä»¶ (.next/static) | âœ… |
| **runner** | å¤åˆ¶ public ç›®å½• | âœ… |

#### å…³é”®æ”¹è¿›
1. âœ… ä½¿ç”¨ `corepack` æ›¿ä»£ `npm install -g pnpm`ï¼ˆæ›´ç°ä»£çš„æ–¹å¼ï¼‰
2. âœ… ç¯å¢ƒå˜é‡ä½¿ç”¨ `=` æ ¼å¼ï¼ˆæ›´è§„èŒƒï¼‰
3. âœ… æ·»åŠ è¯¦ç»†æ³¨é‡Šè¯´æ˜æ¯ä¸ªæ­¥éª¤
4. âœ… ä¼˜åŒ–å±‚ç¼“å­˜ï¼ŒåŠ å¿«æ„å»ºé€Ÿåº¦

---

### 3. .dockerignore é…ç½® âœ…

**æ–‡ä»¶**: `.dockerignore`

| æ’é™¤é¡¹ | è¯´æ˜ | çŠ¶æ€ |
|--------|------|------|
| node_modules | é¿å…é‡å¤å¤åˆ¶ | âœ… |
| .next/ | æ„å»ºäº§ç‰©ä¸å¤åˆ¶ | âœ… |
| æµ‹è¯•æ–‡ä»¶ | *.test.*, **/__tests__ | âœ… |
| ç¯å¢ƒå˜é‡æ–‡ä»¶ | .env* (å®‰å…¨) | âœ… |
| IDE é…ç½® | .vscode, .idea | âœ… |
| Git æ–‡ä»¶ | .git, .gitignore | âœ… |
| CI/CD æ–‡ä»¶ | .github, .gitlab-ci.yml | âœ… |
| Docker æ–‡ä»¶ | Dockerfile*, docker-compose* | âœ… |
| æ–‡æ¡£ | *.md, docs/ | âœ… |
| Linter é…ç½® | biome.json, .eslintrc* | âœ… |
| Husky | .husky (ä¸éœ€è¦åœ¨å®¹å™¨ä¸­) | âœ… |
| Claude Code | .claude/ | âœ… |

**å®‰å…¨æ€§**: âœ… `.env` æ–‡ä»¶å·²æ­£ç¡®æ’é™¤ï¼Œé˜²æ­¢æ•æ„Ÿä¿¡æ¯æ³„éœ²

---

### 4. ç¯å¢ƒå˜é‡å¤„ç† âœ…

**æ–‡ä»¶**: `src/env.ts`

```typescript
skipValidation:
  process.env.NODE_ENV === 'production' && !process.env.DATABASE_URL,
```

| ç‰¹æ€§ | è¯´æ˜ | çŠ¶æ€ |
|------|------|------|
| æ„å»ºæ—¶è·³è¿‡éªŒè¯ | å½“ DATABASE_URL ä¸å­˜åœ¨æ—¶è‡ªåŠ¨è·³è¿‡ | âœ… |
| è¿è¡Œæ—¶éªŒè¯ | Coolify æ³¨å…¥ç¯å¢ƒå˜é‡åè¿›è¡ŒéªŒè¯ | âœ… |
| ç±»å‹å®‰å…¨ | ä½¿ç”¨ Zod è¿›è¡Œç±»å‹æ ¡éªŒ | âœ… |
| é»˜è®¤å€¼ | å…³é”®å­—æ®µæœ‰åˆç†çš„é»˜è®¤å€¼ | âœ… |

**å·¥ä½œæµç¨‹**:
1. æ„å»ºæ—¶ï¼š`NODE_ENV=production` ä¸”æ—  `DATABASE_URL` â†’ è·³è¿‡éªŒè¯ âœ…
2. è¿è¡Œæ—¶ï¼šCoolify æ³¨å…¥æ‰€æœ‰ç¯å¢ƒå˜é‡ â†’ éªŒè¯é€šè¿‡ âœ…

---

### 5. æ„å»ºè„šæœ¬ âœ…

**æ–‡ä»¶**: `package.json`

```json
{
  "scripts": {
    "build": "next build",
    "build:docker": "next build",
    "start": "next start"
  }
}
```

| è„šæœ¬ | ç”¨é€” | çŠ¶æ€ |
|------|------|------|
| `build` | æ ‡å‡†æ„å»ºå‘½ä»¤ | âœ… |
| `build:docker` | Docker æ„å»ºå‘½ä»¤ï¼ˆä¸ build ç›¸åŒï¼‰ | âœ… |
| `start` | ç”Ÿäº§ç¯å¢ƒå¯åŠ¨ | âœ… |
| `prepare` | husky é…ç½®ï¼ˆå·²ä¼˜åŒ–ä¸ºå…è®¸å¤±è´¥ï¼‰ | âœ… |

---

### 6. å¥åº·æ£€æŸ¥ç«¯ç‚¹ âœ…

**æ–‡ä»¶**: `src/app/api/health/route.ts`

```typescript
export const dynamic = 'force-dynamic'
export const runtime = 'edge'
```

| ç‰¹æ€§ | è¯´æ˜ | çŠ¶æ€ |
|------|------|------|
| ç«¯ç‚¹è·¯å¾„ | `/api/health` | âœ… |
| è¿è¡Œæ—¶ | Edge Runtimeï¼ˆå¿«é€Ÿå“åº”ï¼‰ | âœ… |
| å“åº”æ ¼å¼ | JSON (status, timestamp, uptime) | âœ… |
| é”™è¯¯å¤„ç† | 503 é”™è¯¯ç  | âœ… |

**æµ‹è¯•å‘½ä»¤**:
```bash
curl https://your-domain.com/api/health
```

**é¢„æœŸå“åº”**:
```json
{
  "status": "ok",
  "timestamp": "2025-11-13T10:00:00Z",
  "uptime": 123.45,
  "environment": "production"
}
```

---

### 7. Docker Compose é…ç½® âœ…

**æ–‡ä»¶**: `docker-compose.yml`

| ç‰¹æ€§ | è¯´æ˜ | çŠ¶æ€ |
|------|------|------|
| å¥åº·æ£€æŸ¥ | ä½¿ç”¨ `/api/health` ç«¯ç‚¹ | âœ… |
| é‡å¯ç­–ç•¥ | `unless-stopped` | âœ… |
| ç¯å¢ƒå˜é‡ | ä» .env æ–‡ä»¶åŠ è½½ | âœ… |
| ç«¯å£æ˜ å°„ | 3000:3000 | âœ… |

---

## ğŸ¯ Coolify éƒ¨ç½²é…ç½®

### æ¨èè®¾ç½®

```yaml
Build Pack: Dockerfile
Dockerfile Path: Dockerfile
Build Context: .
Port: 3000
Health Check Path: /api/health
Auto Deploy: âœ… (æ¨èå¯ç”¨)
```

### å¿…éœ€ç¯å¢ƒå˜é‡

```bash
# åº”ç”¨
NODE_ENV=production
NEXT_PUBLIC_SITE_URL=https://your-domain.com

# æ•°æ®åº“
DATABASE_URL=postgresql://user:pass@host:5432/db

# è®¤è¯
BETTER_AUTH_SECRET=<32-char-random-string>
BETTER_AUTH_URL=https://your-domain.com

# æ”¯ä»˜
STRIPE_SECRET_KEY=sk_live_xxx
STRIPE_WEBHOOK_SECRET=whsec_xxx
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_live_xxx

# AI (è‡³å°‘ä¸€ä¸ª)
OPENAI_API_KEY=sk-xxx
```

---

## ğŸ“Š æ€§èƒ½ä¸å®‰å…¨è¯„ä¼°

### æ€§èƒ½ä¼˜åŒ– âœ…

| é¡¹ç›® | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| å¤šé˜¶æ®µæ„å»º | âœ… | å‡å°æœ€ç»ˆé•œåƒä½“ç§¯ |
| å±‚ç¼“å­˜ | âœ… | åŠ å¿«æ„å»ºé€Ÿåº¦ |
| Alpine åŸºç¡€é•œåƒ | âœ… | é•œåƒå¤§å° ~100MB vs ~1GB |
| Standalone è¾“å‡º | âœ… | åªåŒ…å«å¿…éœ€æ–‡ä»¶ |
| ä»£ç åˆ†å‰² | âœ… | Webpack é…ç½®ä¼˜åŒ– |
| Tree Shaking | âœ… | ç§»é™¤æœªä½¿ç”¨ä»£ç  |
| å‹ç¼© | âœ… | Gzip å‹ç¼©å·²å¯ç”¨ |
| é™æ€èµ„æºç¼“å­˜ | âœ… | 30 å¤©ç¼“å­˜ç­–ç•¥ |

### å®‰å…¨æ€§ âœ…

| é¡¹ç›® | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| é root ç”¨æˆ· | âœ… | ä½¿ç”¨ nextjs:nodejs (1001) |
| ç¯å¢ƒå˜é‡éš”ç¦» | âœ… | .env æ–‡ä»¶ä¸è¿›å…¥é•œåƒ |
| å®‰å…¨å¤´éƒ¨ | âœ… | X-Frame-Options, CSP ç­‰ |
| ä¾èµ–é”å®š | âœ… | pnpm-lock.yaml |
| æœ€å°åŒ–æ”»å‡»é¢ | âœ… | åªå®‰è£…ç”Ÿäº§ä¾èµ– |
| æ•æ„Ÿä¿¡æ¯ä¿æŠ¤ | âœ… | å¯†é’¥é€šè¿‡ç¯å¢ƒå˜é‡æ³¨å…¥ |

### å¯ç»´æŠ¤æ€§ âœ…

| é¡¹ç›® | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| æ–‡æ¡£å®Œå–„ | âœ… | DEPLOYMENT.md, CHECKLIST.md |
| å¥åº·æ£€æŸ¥ | âœ… | /api/health ç«¯ç‚¹ |
| æ—¥å¿—è®°å½• | âœ… | Console logs å¯åœ¨ Coolify æŸ¥çœ‹ |
| ç‰ˆæœ¬æ§åˆ¶ | âœ… | Git tags æ”¯æŒ |
| å›æ»šèƒ½åŠ› | âœ… | Coolify æ”¯æŒå¿«é€Ÿå›æ»š |

---

## ğŸš€ éƒ¨ç½²å°±ç»ªçŠ¶æ€

### âœ… æ ¸å¿ƒæ£€æŸ¥é€šè¿‡

- [x] Next.js é…ç½®æ­£ç¡®
- [x] Dockerfile ä¼˜åŒ–å®Œæˆ
- [x] .dockerignore é…ç½®å®Œå–„
- [x] ç¯å¢ƒå˜é‡å¤„ç†æ­£ç¡®
- [x] å¥åº·æ£€æŸ¥ç«¯ç‚¹å®ç°
- [x] å®‰å…¨æ€§é…ç½®åˆ°ä½
- [x] æ€§èƒ½ä¼˜åŒ–å®Œæˆ
- [x] æ–‡æ¡£é½å…¨

### ğŸ“‹ éƒ¨ç½²å‰å‡†å¤‡

1. âœ… ä»£ç æ¨é€åˆ° Git ä»“åº“
2. âœ… åœ¨ Coolify é€‰æ‹© **Dockerfile** ä½œä¸º Build Pack
3. â³ é…ç½®æ‰€æœ‰å¿…éœ€çš„ç¯å¢ƒå˜é‡
4. â³ è®¾ç½®åŸŸåå’Œ SSL
5. â³ è¿è¡Œæ•°æ®åº“è¿ç§»
6. â³ é…ç½® Stripe Webhook

---

## ğŸ‰ æ€»ç»“

**å½“å‰é…ç½®çŠ¶æ€**: âœ… **ç”Ÿäº§å°±ç»ª (Production Ready)**

### ä¼˜ç‚¹
1. âœ… é‡‡ç”¨æœ€ä½³å®è·µçš„å¤šé˜¶æ®µ Docker æ„å»º
2. âœ… å®Œå–„çš„å®‰å…¨é…ç½®ï¼ˆé root ç”¨æˆ·ï¼Œå®‰å…¨å¤´éƒ¨ï¼‰
3. âœ… ä¼˜ç§€çš„æ€§èƒ½ä¼˜åŒ–ï¼ˆä»£ç åˆ†å‰²ï¼Œç¼“å­˜ç­–ç•¥ï¼‰
4. âœ… å¥å£®çš„ç¯å¢ƒå˜é‡å¤„ç†
5. âœ… å®Œæ•´çš„æ–‡æ¡£å’Œéƒ¨ç½²æŒ‡å—
6. âœ… å¥åº·æ£€æŸ¥ç«¯ç‚¹æ”¯æŒ

### å»ºè®®
1. ğŸ’¡ å¯ç”¨ Redis ç¼“å­˜ä»¥æå‡æ€§èƒ½
2. ğŸ’¡ é…ç½® CDN åŠ é€Ÿé™æ€èµ„æº
3. ğŸ’¡ è®¾ç½®ç›‘æ§å‘Šè­¦ï¼ˆSentry, Uptime Robotï¼‰
4. ğŸ’¡ å®šæœŸå¤‡ä»½æ•°æ®åº“
5. ğŸ’¡ é…ç½®æ—¥å¿—èšåˆï¼ˆå¦‚ Lokiï¼‰

### é¢„ä¼°æŒ‡æ ‡
- **æ„å»ºæ—¶é—´**: 5-8 åˆ†é’Ÿï¼ˆé¦–æ¬¡ï¼‰/ 2-3 åˆ†é’Ÿï¼ˆç¼“å­˜åï¼‰
- **é•œåƒå¤§å°**: ~150-200 MB
- **å¯åŠ¨æ—¶é—´**: 5-10 ç§’
- **å†…å­˜ä½¿ç”¨**: ~100-200 MBï¼ˆç©ºé—²ï¼‰/ ~500 MBï¼ˆè´Ÿè½½ï¼‰
- **å¯ç”¨æ€§**: 99.9%+

---

## ğŸ“ æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼š
1. æŸ¥çœ‹ `DEPLOYMENT.md` éƒ¨ç½²æŒ‡å—
2. æŸ¥çœ‹ `.coolify/CHECKLIST.md` æ£€æŸ¥æ¸…å•
3. æ£€æŸ¥ Coolify æ„å»ºæ—¥å¿—
4. æäº¤ Issue åˆ° GitHub ä»“åº“

---

**å‡†å¤‡éƒ¨ç½²**: âœ… å¯ä»¥å¼€å§‹éƒ¨ç½²åˆ° Coolifyï¼
